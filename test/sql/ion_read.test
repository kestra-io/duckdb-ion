# name: test/sql/ion_read.test
# description: read_ion table function
# group: [sql]

require ion

query IIIIII
SELECT bigint,
       varchar,
       bool,
       decimal,
       strftime(timestamptz::TIMESTAMP, '%Y-%m-%dT%H:%M:%S.%fZ') AS ts,
       hex(blob) AS blob
FROM read_ion('test/ion/sample.ion');
----
1	two	true	12.340000000000000000	2020-01-02T03:04:05.678000Z	010203
2	three	NULL	NULL	NULL	NULL
NULL	NULL	false	NULL	NULL	NULL

query III
SELECT bigint, varchar, bool
FROM read_ion('test/ion/sample.ion', columns := {bigint: 'BIGINT', varchar: 'VARCHAR', bool: 'BOOLEAN'});
----
1	two	true
2	three	NULL
NULL	NULL	false

statement error
SELECT * FROM read_ion('test/ion/sample.ion', columns := 'BIGINT');
----
Binder Error: read_ion "columns" parameter requires a struct as input.

statement error
SELECT * FROM read_ion('test/ion/sample.ion', columns := {bigint: NULL});
----
Binder Error: read_ion "columns" parameter type specification cannot be NULL.

statement error
SELECT * FROM read_ion('test/ion/sample.ion', columns := {bigint: 1});
----
Binder Error: read_ion "columns" parameter type specification must be VARCHAR.

statement error
SELECT * FROM read_ion('test/ion/sample.ion', foo := 1);
----
Binder Error: Invalid named parameter "foo" for function read_ion

query I
SELECT ion FROM read_ion('test/ion/scalars.ion', records := 'false');
----
1
2
3

query III
SELECT bigint, varchar, bool
FROM read_ion('test/ion/array.ion', format := 'array');
----
1	two	true
2	three	false

query IIII
SELECT id,
       nested.name,
       list_extract(tags, 1),
       list_extract(nums, 2)
FROM read_ion('test/ion/nested.ion');
----
1	alpha	x	2
two	beta	z	NULL

query I
SELECT typeof(id) FROM read_ion('test/ion/nested.ion') LIMIT 1;
----
VARCHAR

query IIII
SELECT id,
       nested.name,
       list_extract(tags, 1),
       list_extract(nums, 2)
FROM read_ion('test/ion/nested.ion',
              columns := {id: 'VARCHAR',
                          nested: 'STRUCT(name VARCHAR, score BIGINT)',
                          tags: 'VARCHAR[]',
                          nums: 'BIGINT[]'});
----
1	alpha	x	2
two	beta	z	NULL

query II
SELECT typeof(nested.score),
       typeof(list_extract(nums, 1))
FROM read_ion('test/ion/conflicts.ion') LIMIT 1;
----
VARCHAR	VARCHAR

query I
SELECT typeof(list_extract(nums, 1))
FROM read_ion('test/ion/conflicts.ion') LIMIT 1;
----
VARCHAR

query II
SELECT nested.score,
       list_extract(nums, 1)
FROM read_ion('test/ion/conflicts.ion');
----
10	1
high	x
12.500000000000000000	3
7	{'k': 1}
